<!DOCTYPE html>
<html lang="en" class="overflow-x-hidden">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HYROX Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    gold: '#f5c842',
                    hyrox: '#ff6b35',
                    surface: '#141414',
                    dark: '#0a0a0a',
                    dim: '#1e1e1e',
                }
            }
        },
        safelist: [
            'bg-emerald-400','bg-gold','bg-gold/5','bg-gold/15',
            'bg-[#333]','bg-[#222]',
            'bg-indigo-500/15','bg-emerald-400/15','bg-hyrox/15','bg-pink-500/15','bg-slate-500/10',
            'border-emerald-400','border-emerald-400/30','border-gold','border-[#222]','border-[#333]',
            'text-dark','text-gold','text-hyrox','text-emerald-400','text-red-500',
            'text-gray-500','text-gray-600',
            'text-indigo-400','text-pink-500','text-slate-500',
            'opacity-0','opacity-100',
            'block','hidden',
        ]
    }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>body { -webkit-text-size-adjust: 100%; }</style>
</head>
<body class="bg-dark text-gray-200 min-h-screen p-3 md:p-5 overflow-x-hidden font-sans">

    <!-- AUTH OVERLAY -->
    <div class="fixed inset-0 bg-dark z-50 flex items-center justify-center p-4 hidden" id="authOverlay">
        <div class="bg-surface border border-[#222] rounded-2xl p-6 md:p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-extrabold uppercase tracking-[4px] bg-gradient-to-br from-gold to-hyrox bg-clip-text text-transparent text-center mb-1">HYROX</h2>
            <p class="text-[0.6rem] text-center text-gray-600 uppercase tracking-[2px] mb-6">Sign In</p>

            <div class="flex gap-1 mb-5">
                <button class="flex-1 bg-dim border border-gold text-gold py-3 rounded-lg text-xs font-semibold uppercase text-center transition-all" id="authSignIn" onclick="setAuthMode('signin')">Sign In</button>
                <button class="flex-1 bg-dim border border-[#222] text-gray-600 py-3 rounded-lg text-xs font-semibold uppercase text-center transition-all" id="authSignUp" onclick="setAuthMode('signup')">Sign Up</button>
            </div>

            <div class="mb-3">
                <label class="block text-[0.6rem] uppercase tracking-wide text-gray-600 font-semibold mb-1">Email</label>
                <input type="email" id="authEmail" placeholder="you@example.com"
                       class="w-full bg-dim border border-[#2a2a2a] text-gray-400 p-3 rounded-lg text-base outline-none focus:border-gold transition-colors">
            </div>
            <div class="mb-3">
                <label class="block text-[0.6rem] uppercase tracking-wide text-gray-600 font-semibold mb-1">Password</label>
                <input type="password" id="authPassword" placeholder="Your password"
                       class="w-full bg-dim border border-[#2a2a2a] text-gray-400 p-3 rounded-lg text-base outline-none focus:border-gold transition-colors">
            </div>

            <button class="w-full bg-gradient-to-r from-gold to-hyrox text-dark p-3 rounded-lg text-sm font-bold uppercase tracking-[2px] mt-2 cursor-pointer hover:opacity-90 disabled:opacity-50 disabled:cursor-not-allowed" onclick="doAuth()" id="authBtn">Sign In</button>
            <div class="text-red-500 text-xs mt-2 text-center hidden" id="authError"></div>
            <div class="text-emerald-400 text-xs mt-2 text-center hidden" id="authSuccess"></div>

            <p class="text-[0.6rem] text-gray-600 text-center mt-4 leading-relaxed">
                Your workouts sync across all devices.
            </p>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div class="fixed inset-0 bg-dark z-50 flex items-center justify-center p-5 hidden" id="loadingOverlay">
        <p class="text-gray-600 text-sm">Loading your data...</p>
    </div>

    <!-- MAIN TRACKER -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <div class="text-center mb-2 md:mb-4">
            <h1 class="text-xl md:text-2xl font-extrabold uppercase tracking-[4px] md:tracking-[6px] bg-gradient-to-br from-gold to-hyrox bg-clip-text text-transparent leading-none mb-1">HYROX</h1>
            <p class="text-[0.55rem] md:text-[0.6rem] tracking-[2px] md:tracking-[3px] uppercase text-gray-600" id="subtitleText">Training Tracker &middot; Pro Division</p>
        </div>

        <!-- Week Nav -->
        <div class="flex items-center justify-center gap-1 md:gap-4 mb-3 md:mb-4">
            <button onclick="changeWeek(-1)" class="bg-dim border border-[#333] text-gray-400 px-3 py-2.5 rounded-lg text-xs font-semibold cursor-pointer hover:border-gold hover:text-gold min-w-[44px]">&larr; Prev</button>
            <div class="text-xs md:text-sm font-semibold text-gray-500 text-center flex-1 md:flex-initial" id="weekLabel"></div>
            <button onclick="changeWeek(1)" class="bg-dim border border-[#333] text-gray-400 px-3 py-2.5 rounded-lg text-xs font-semibold cursor-pointer hover:border-gold hover:text-gold min-w-[44px]">Next &rarr;</button>
        </div>

        <!-- Mobile Day Selector -->
        <div class="flex md:hidden items-center gap-2 mb-3">
            <select id="dayDropdown" onchange="selectDay(this.value)"
                    class="flex-1 min-w-0 bg-surface border border-[#333] text-gold p-3 rounded-xl text-base font-bold outline-none">
            </select>
            <span class="text-emerald-400 text-[0.6rem] font-semibold flex-shrink-0" id="syncStatusMobile">Synced</span>
            <button onclick="toggleMobileSettings()" class="mobile-settings-btn bg-surface border border-[#333] text-gray-500 w-11 h-11 rounded-xl text-lg cursor-pointer flex items-center justify-center flex-shrink-0 hover:border-gold hover:text-gold transition-colors">&#9881;</button>
        </div>

        <!-- Settings Drawer: hidden on mobile (toggled), always visible on desktop -->
        <div id="settingsDrawer" class="md:block hidden mb-3 p-3 md:p-0 bg-[#111] md:bg-transparent border border-[#1e1e1e] md:border-0 rounded-xl md:rounded-none">
            <div class="grid grid-cols-2 md:flex md:justify-center gap-1.5 md:gap-1 mb-3 md:mb-4">
                <button class="div-btn bg-surface border border-gold text-gold bg-gold/5 py-2.5 md:py-1.5 px-2 md:px-3 rounded-lg text-[0.65rem] font-semibold uppercase tracking-wide text-center cursor-pointer transition-all" onclick="setDivision('pro')" id="div-pro">Pro</button>
                <button class="div-btn bg-surface border border-[#222] text-gray-600 py-2.5 md:py-1.5 px-2 md:px-3 rounded-lg text-[0.65rem] font-semibold uppercase tracking-wide text-center cursor-pointer transition-all" onclick="setDivision('open')" id="div-open">Men's Open</button>
                <button class="div-btn bg-surface border border-[#222] text-gray-600 py-2.5 md:py-1.5 px-2 md:px-3 rounded-lg text-[0.65rem] font-semibold uppercase tracking-wide text-center cursor-pointer transition-all" onclick="setDivision('doubles')" id="div-doubles">Doubles</button>
                <button class="div-btn bg-surface border border-[#222] text-gray-600 py-2.5 md:py-1.5 px-2 md:px-3 rounded-lg text-[0.65rem] font-semibold uppercase tracking-wide text-center cursor-pointer transition-all" onclick="setDivision('doubles-pro')" id="div-doubles-pro">Doubles Pro</button>
            </div>
            <div class="flex justify-center gap-2 items-center flex-wrap">
                <span class="text-emerald-400 text-[0.55rem] font-semibold tracking-wide" id="syncStatus">Synced</span>
                <button class="bg-dim border border-[#2a2a2a] text-gray-500 px-3 py-2.5 md:py-1.5 rounded-md text-[0.65rem] font-semibold uppercase tracking-wide cursor-pointer transition-all hover:border-gold hover:text-gold" onclick="signOut()" id="signOutBtn">Sign Out</button>
                <button class="bg-dim border border-[#2a2a2a] text-gray-500 px-3 py-2.5 md:py-1.5 rounded-md text-[0.65rem] font-semibold uppercase tracking-wide cursor-pointer transition-all hover:border-gold hover:text-gold" onclick="exportData()" id="exportBtn">Export</button>
                <button class="bg-dim border border-[#2a2a2a] text-gray-500 px-3 py-2.5 md:py-1.5 rounded-md text-[0.65rem] font-semibold uppercase tracking-wide cursor-pointer transition-all hover:border-gold hover:text-gold" onclick="document.getElementById('importInput').click()">Import</button>
                <input type="file" id="importInput" accept=".json" onchange="importData(event)" class="hidden">
            </div>
        </div>

        <!-- Desktop Tabs -->
        <div class="hidden md:flex gap-1 mb-4 justify-center flex-wrap" id="tabs"></div>

        <!-- Day Panels (rendered by JS) -->
        <div id="dayPanels"></div>

        <!-- History Panel -->
        <div class="max-w-2xl mx-auto hidden" id="historyPanel">
            <h3 class="text-sm font-bold uppercase tracking-[2px] mb-4 text-center">Weekly History</h3>
            <div id="historyList"></div>
        </div>

        <!-- Tips (desktop only) -->
        <div class="hidden md:flex max-w-2xl mx-auto mt-4 p-2 px-3 bg-[#111] rounded-lg border border-[#1a1a1a] gap-4 flex-wrap">
            <div class="text-[0.55rem] text-gray-600 flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gold flex-shrink-0"></span>Train sleds heavier than race weight</div>
            <div class="text-[0.55rem] text-gray-600 flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gold flex-shrink-0"></span>Deload every 3-4 weeks</div>
            <div class="text-[0.55rem] text-gray-600 flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gold flex-shrink-0"></span>Full race sim every 4-6 weeks</div>
            <div class="text-[0.55rem] text-gray-600 flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gold flex-shrink-0"></span>80/20 intensity split</div>
            <div class="text-[0.55rem] text-gray-600 flex items-center gap-1"><span class="w-1 h-1 rounded-full bg-gold flex-shrink-0"></span>Roxzone transitions &lt;10s</div>
        </div>

        <!-- Save indicator -->
        <div class="fixed bottom-4 right-4 text-xs text-emerald-400 opacity-0 transition-opacity duration-300 pointer-events-none" id="saveIndicator">Saved</div>
    </div>

    <script>
    /* ====================
       CONSTANTS
       ==================== */
    const WEIGHTS = {
        pro:          { sledpush: '50m \u00b7 202kg', sledpull: '50m \u00b7 153kg', farmer: '200m \u00b7 2\u00d732kg', lunges: '100m \u00b7 30kg', wallballs: '100 reps \u00b7 9kg' },
        open:         { sledpush: '50m \u00b7 152kg', sledpull: '50m \u00b7 103kg', farmer: '200m \u00b7 2\u00d724kg', lunges: '100m \u00b7 20kg', wallballs: '100 reps \u00b7 6kg' },
        doubles:      { sledpush: '50m \u00b7 152kg (split)', sledpull: '50m \u00b7 103kg (split)', farmer: '200m \u00b7 2\u00d724kg (split)', lunges: '100m \u00b7 20kg (split)', wallballs: '100 reps \u00b7 6kg (split)' },
        'doubles-pro': { sledpush: '50m \u00b7 202kg (split)', sledpull: '50m \u00b7 153kg (split)', farmer: '200m \u00b7 2\u00d732kg (split)', lunges: '100m \u00b7 30kg (split)', wallballs: '100 reps \u00b7 9kg (split)' },
    };

    const DIV_LABELS = { pro: 'Pro Division', open: "Men's Open", doubles: 'Doubles', 'doubles-pro': 'Doubles Pro' };

    const PLAN = {
        monday: {
            name: 'Monday', tags: ['strength', 'stations'],
            sessions: [
                {
                    id: 'strength', time: 'Morning', name: 'Upper Body Strength Endurance',
                    desc: '~45 min \u00b7 Moderate weight, higher reps',
                    fields: [{ id: 'duration', label: 'Duration', placeholder: '45 min' }]
                },
                {
                    id: 'stations', time: 'Lunchtime', name: 'Upper Body Stations',
                    desc: 'Technique focus, no runs',
                    stations: [
                        { id: 'skierg', name: 'SkiErg', placeholder: 'e.g. 4:30' },
                        { id: 'rowerg', name: 'RowErg', placeholder: 'e.g. 4:15' },
                        { id: 'farmer', name: 'Farmer Carries', placeholder: 'e.g. 2:00' },
                        { id: 'wallballs', name: 'Wall Balls', placeholder: 'e.g. 8:30' },
                    ]
                }
            ]
        },
        tuesday: {
            name: 'Tuesday', tags: ['strength', 'stations'],
            sessions: [
                {
                    id: 'strength', time: 'Morning', name: 'Lower Body Strength Endurance',
                    desc: '~45 min \u00b7 Moderate weight, higher reps',
                    fields: [{ id: 'duration', label: 'Duration', placeholder: '45 min' }]
                },
                {
                    id: 'stations', time: 'Evening', name: 'Lower Body Stations \u2014 Compromised',
                    desc: 'Roxzone transitions <10s',
                    stations: [
                        { id: 'run1', name: '1km Run', placeholder: 'e.g. 4:20', isRun: true },
                        { id: 'sledpush', name: 'Sled Push', placeholder: 'e.g. 3:00' },
                        { id: 'run2', name: '1km Run', placeholder: 'e.g. 4:25', isRun: true },
                        { id: 'sledpull', name: 'Sled Pull', placeholder: 'e.g. 2:30' },
                        { id: 'run3', name: '1km Run', placeholder: 'e.g. 4:30', isRun: true },
                        { id: 'burpee', name: 'Burpee Broad Jumps', placeholder: 'e.g. 5:00' },
                        { id: 'run4', name: '1km Run', placeholder: 'e.g. 4:35', isRun: true },
                        { id: 'lunges', name: 'Sandbag Lunges', placeholder: 'e.g. 6:00' },
                    ]
                }
            ]
        },
        wednesday: {
            name: 'Wednesday', tags: ['recovery'],
            sessions: [
                {
                    id: 'mobility', time: '', name: 'Mobility',
                    desc: '30 min \u00b7 Full body',
                    fields: [{ id: 'duration', label: 'Duration', placeholder: '30 min' }]
                },
                {
                    id: 'rehab', time: '', name: 'Shoulder Rehab',
                    desc: 'Rehab work',
                    fields: []
                },
                {
                    id: 'zone2', time: '', name: 'Zone 2 Jog',
                    desc: '45-60 min \u00b7 Conversational pace',
                    fields: [
                        { id: 'duration', label: 'Duration', placeholder: '50 min' },
                        { id: 'distance', label: 'Distance', placeholder: '8 km' },
                        { id: 'pace', label: 'Avg Pace', placeholder: '6:15/km' },
                    ]
                },
                {
                    id: 'sauna', time: '', name: 'Sauna',
                    desc: 'Recovery',
                    fields: [{ id: 'duration', label: 'Duration', placeholder: '15 min' }]
                }
            ]
        },
        thursday: {
            name: 'Thursday', tags: ['strength', 'stations'],
            sessions: [
                {
                    id: 'strength', time: 'Morning', name: 'Upper Body Strength Endurance',
                    desc: '~45 min \u00b7 Moderate weight, higher reps',
                    fields: [{ id: 'duration', label: 'Duration', placeholder: '45 min' }]
                },
                {
                    id: 'stations', time: 'Lunchtime', name: 'Upper Body Stations \u2014 Compromised',
                    desc: 'Roxzone transitions <10s',
                    stations: [
                        { id: 'run1', name: '1km Run', placeholder: 'e.g. 4:20', isRun: true },
                        { id: 'skierg', name: 'SkiErg', placeholder: 'e.g. 4:30' },
                        { id: 'run2', name: '1km Run', placeholder: 'e.g. 4:25', isRun: true },
                        { id: 'rowerg', name: 'RowErg', placeholder: 'e.g. 4:15' },
                        { id: 'run3', name: '1km Run', placeholder: 'e.g. 4:30', isRun: true },
                        { id: 'farmer', name: 'Farmer Carries', placeholder: 'e.g. 2:00' },
                        { id: 'run4', name: '1km Run', placeholder: 'e.g. 4:35', isRun: true },
                        { id: 'wallballs', name: 'Wall Balls', placeholder: 'e.g. 8:30' },
                    ]
                }
            ]
        },
        friday: {
            name: 'Friday', tags: ['speed', 'stations'],
            sessions: [
                {
                    id: 'speed', time: 'Morning', name: 'Speed Intervals',
                    desc: '8x 400m fast, 90s recovery',
                    fields: [
                        { id: 'rep1', label: '400m #1', placeholder: 'e.g. 1:35' },
                        { id: 'rep2', label: '400m #2', placeholder: 'e.g. 1:36' },
                        { id: 'rep3', label: '400m #3', placeholder: 'e.g. 1:37' },
                        { id: 'rep4', label: '400m #4', placeholder: 'e.g. 1:38' },
                        { id: 'rep5', label: '400m #5', placeholder: 'e.g. 1:38' },
                        { id: 'rep6', label: '400m #6', placeholder: 'e.g. 1:40' },
                        { id: 'rep7', label: '400m #7', placeholder: 'e.g. 1:41' },
                        { id: 'rep8', label: '400m #8', placeholder: 'e.g. 1:42' },
                    ]
                },
                {
                    id: 'stations', time: 'Lunchtime', name: 'Lower Body Stations',
                    desc: 'No runs \u2014 keep legs fresh for Saturday',
                    stations: [
                        { id: 'sledpush', name: 'Sled Push', placeholder: 'e.g. 3:00' },
                        { id: 'sledpull', name: 'Sled Pull', placeholder: 'e.g. 2:30' },
                        { id: 'burpee', name: 'Burpee Broad Jumps', placeholder: 'e.g. 5:00' },
                        { id: 'lunges', name: 'Sandbag Lunges', placeholder: 'e.g. 6:00' },
                    ]
                }
            ]
        },
        saturday: {
            name: 'Saturday', tags: ['run'],
            sessions: [
                {
                    id: 'longrun', time: '', name: 'Long Zone 2 Run',
                    desc: '45-90 min \u00b7 Conversational pace',
                    fields: [
                        { id: 'duration', label: 'Duration', placeholder: '60 min' },
                        { id: 'distance', label: 'Distance', placeholder: '10 km' },
                        { id: 'pace', label: 'Avg Pace', placeholder: '6:00/km' },
                        { id: 'avghr', label: 'Avg HR', placeholder: '140 bpm' },
                    ]
                }
            ]
        },
        sunday: {
            name: 'Sunday', tags: ['rest'],
            sessions: [
                { id: 'rest', time: '', name: 'Full Rest Day', desc: 'Recovery', fields: [] }
            ]
        }
    };

    const DAYS = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
    const TAG_CLASSES = {
        strength: 'bg-indigo-500/15 text-indigo-400',
        stations: 'bg-gold/15 text-gold',
        recovery: 'bg-emerald-400/15 text-emerald-400',
        run: 'bg-hyrox/15 text-hyrox',
        rest: 'bg-slate-500/10 text-slate-500',
        speed: 'bg-pink-500/15 text-pink-500',
    };

    /* ====================
       STATE
       ==================== */
    let sb = null;
    let currentUser = null;
    let isCloud = false;

    let currentDivision = 'pro';
    let currentWeek = getWeekId(new Date());
    let activeDay = DAYS[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];
    let data = {};
    let showHistory = false;
    let syncTimeout = null;

    /* ====================
       SUPABASE CONFIG
       ==================== */
    const SUPABASE_URL = 'https://eatryfrdiahywcnpnula.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kvU242qD2fDCk_Ol1OQ--Q_rYSl43lD';

    /* ====================
       AUTH
       ==================== */
    let authMode = 'signin';

    function setAuthMode(mode) {
        authMode = mode;
        const signin = document.getElementById('authSignIn');
        const signup = document.getElementById('authSignUp');

        signin.classList.toggle('border-gold', mode === 'signin');
        signin.classList.toggle('text-gold', mode === 'signin');
        signin.classList.toggle('border-[#222]', mode !== 'signin');
        signin.classList.toggle('text-gray-600', mode !== 'signin');

        signup.classList.toggle('border-gold', mode === 'signup');
        signup.classList.toggle('text-gold', mode === 'signup');
        signup.classList.toggle('border-[#222]', mode !== 'signup');
        signup.classList.toggle('text-gray-600', mode !== 'signup');

        document.getElementById('authBtn').textContent = mode === 'signin' ? 'Sign In' : 'Sign Up';
        document.getElementById('authError').classList.add('hidden');
        document.getElementById('authSuccess').classList.add('hidden');
    }

    async function doAuth() {
        const email = document.getElementById('authEmail').value.trim();
        const password = document.getElementById('authPassword').value.trim();
        const errEl = document.getElementById('authError');
        const successEl = document.getElementById('authSuccess');
        const btn = document.getElementById('authBtn');

        errEl.classList.add('hidden');
        successEl.classList.add('hidden');

        if (!email || !password) {
            errEl.textContent = 'Email and password are required.';
            errEl.classList.remove('hidden');
            return;
        }

        if (password.length < 6) {
            errEl.textContent = 'Password must be at least 6 characters.';
            errEl.classList.remove('hidden');
            return;
        }

        btn.disabled = true;
        btn.textContent = authMode === 'signin' ? 'Signing in...' : 'Signing up...';

        try {
            let result;
            if (authMode === 'signup') {
                result = await sb.auth.signUp({ email, password });
                if (result.error) throw result.error;

                if (result.data.user && !result.data.session) {
                    successEl.textContent = 'Check your email to confirm your account, then sign in.';
                    successEl.classList.remove('hidden');
                    btn.disabled = false;
                    btn.textContent = 'Sign Up';
                    return;
                }
            } else {
                result = await sb.auth.signInWithPassword({ email, password });
                if (result.error) throw result.error;
            }

            currentUser = result.data.user;
            isCloud = true;
            await loadCloudData();
            showOverlay(null);
            startTracker();
        } catch (err) {
            errEl.textContent = err.message || 'Authentication failed.';
            errEl.classList.remove('hidden');
        }

        btn.disabled = false;
        btn.textContent = authMode === 'signin' ? 'Sign In' : 'Sign Up';
    }

    async function signOut() {
        if (sb) await sb.auth.signOut();
        currentUser = null;
        isCloud = false;
        data = {};
        showOverlay('auth');
    }

    /* ====================
       CLOUD DATA SYNC
       ==================== */
    async function loadCloudData() {
        if (!sb || !currentUser) return;
        setSyncStatus('syncing', 'Loading...');

        try {
            const { data: rows, error } = await sb
                .from('workouts')
                .select('week_id, data')
                .eq('user_id', currentUser.id);

            if (error) throw error;

            data = {};
            rows.forEach(row => { data[row.week_id] = row.data; });

            const localData = JSON.parse(localStorage.getItem('hyrox-data') || '{}');
            if (Object.keys(localData).length > 0 && Object.keys(data).length === 0) {
                data = localData;
                for (const weekId of Object.keys(data)) {
                    await sb.from('workouts').upsert({
                        user_id: currentUser.id,
                        week_id: weekId,
                        data: data[weekId],
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id,week_id' });
                }
            }

            localStorage.setItem('hyrox-data', JSON.stringify(data));

            const { data: settings } = await sb
                .from('user_settings')
                .select('division')
                .eq('user_id', currentUser.id)
                .single();

            if (settings && settings.division) {
                currentDivision = settings.division;
            }

            setSyncStatus('synced', 'Synced');
        } catch (err) {
            console.error('Load error:', err);
            data = JSON.parse(localStorage.getItem('hyrox-data') || '{}');
            setSyncStatus('error', 'Sync error');
        }
    }

    async function syncWeekToCloud(weekId) {
        if (!sb || !currentUser) return;
        setSyncStatus('syncing', 'Syncing...');

        try {
            const weekData = data[weekId] || {};
            const { error } = await sb.from('workouts').upsert({
                user_id: currentUser.id,
                week_id: weekId,
                data: weekData,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id,week_id' });

            if (error) throw error;
            setSyncStatus('synced', 'Synced');
        } catch (err) {
            console.error('Sync error:', err);
            setSyncStatus('error', 'Sync error');
        }
    }

    async function syncDivisionToCloud() {
        if (!sb || !currentUser) return;
        try {
            await sb.from('user_settings').upsert({
                user_id: currentUser.id,
                division: currentDivision,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });
        } catch (err) {
            console.error('Division sync error:', err);
        }
    }

    function setSyncStatus(cls, text) {
        const colorMap = { synced: 'text-emerald-400', syncing: 'text-gold', error: 'text-red-500', local: 'text-gray-600' };
        const color = colorMap[cls] || 'text-gray-600';
        ['syncStatus', 'syncStatusMobile'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.className = 'text-[0.55rem] font-semibold tracking-wide flex-shrink-0 ' + color;
                el.textContent = text;
            }
        });
    }

    /* ====================
       OVERLAY MANAGEMENT
       ==================== */
    function showOverlay(which) {
        document.getElementById('authOverlay').classList.toggle('hidden', which !== 'auth');
        document.getElementById('loadingOverlay').classList.toggle('hidden', which !== 'loading');
        document.getElementById('mainApp').classList.toggle('hidden', which !== null);
    }

    /* ====================
       TRACKER CORE
       ==================== */
    function getSpec(stationId) {
        if (stationId === 'skierg' || stationId === 'rowerg') return '1000m';
        if (stationId === 'burpee') return '80m';
        return WEIGHTS[currentDivision][stationId] || '';
    }

    function setDivision(div) {
        currentDivision = div;
        localStorage.setItem('hyrox-division', div);
        const active = ['border-gold', 'text-gold', 'bg-gold/5'];
        const inactive = ['border-[#222]', 'text-gray-600'];
        document.querySelectorAll('.div-btn').forEach(b => {
            b.classList.remove(...active, ...inactive);
            b.classList.add(...inactive);
        });
        const btn = document.getElementById('div-' + div);
        btn.classList.remove(...inactive);
        btn.classList.add(...active);
        document.getElementById('subtitleText').innerHTML = 'Training Tracker &middot; ' + DIV_LABELS[div];
        if (isCloud) syncDivisionToCloud();
        render();
    }

    function getWeekId(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day === 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));
        const yyyy = monday.getFullYear();
        const mm = String(monday.getMonth() + 1).padStart(2, '0');
        const dd = String(monday.getDate()).padStart(2, '0');
        return yyyy + '-' + mm + '-' + dd;
    }

    function getWeekDisplay(weekId) {
        const d = new Date(weekId + 'T00:00:00');
        const end = new Date(d);
        end.setDate(end.getDate() + 6);
        const opts = { day: 'numeric', month: 'short' };
        return d.toLocaleDateString('en-GB', opts) + ' \u2014 ' + end.toLocaleDateString('en-GB', opts);
    }

    function isCurrentWeek(weekId) { return weekId === getWeekId(new Date()); }

    function changeWeek(dir) {
        const d = new Date(currentWeek + 'T00:00:00');
        d.setDate(d.getDate() + dir * 7);
        currentWeek = getWeekId(d);
        render();
    }

    function getSessionData(day, sessionId) {
        if (!data[currentWeek]) return {};
        if (!data[currentWeek][day]) return {};
        return data[currentWeek][day][sessionId] || {};
    }

    function setSessionData(day, sessionId, key, value) {
        if (!data[currentWeek]) data[currentWeek] = {};
        if (!data[currentWeek][day]) data[currentWeek][day] = {};
        if (!data[currentWeek][day][sessionId]) data[currentWeek][day][sessionId] = {};
        data[currentWeek][day][sessionId][key] = value;
        save();
    }

    function save() {
        localStorage.setItem('hyrox-data', JSON.stringify(data));
        showSaveIndicator();

        if (isCloud) {
            clearTimeout(syncTimeout);
            setSyncStatus('syncing', 'Syncing...');
            syncTimeout = setTimeout(() => syncWeekToCloud(currentWeek), 1500);
        }
    }

    function showSaveIndicator() {
        const el = document.getElementById('saveIndicator');
        el.classList.remove('opacity-0');
        el.classList.add('opacity-100');
        setTimeout(() => {
            el.classList.remove('opacity-100');
            el.classList.add('opacity-0');
        }, 1200);
    }

    function isSessionCompleted(day, sessionId) {
        return getSessionData(day, sessionId).completed === true;
    }

    function getDayCompletion(day) {
        const plan = PLAN[day];
        const total = plan.sessions.length;
        let done = 0;
        plan.sessions.forEach(s => { if (isSessionCompleted(day, s.id)) done++; });
        if (done === 0) return 'none';
        if (done === total) return 'done';
        return 'partial';
    }

    function toggleComplete(day, sessionId) {
        setSessionData(day, sessionId, 'completed', !isSessionCompleted(day, sessionId));
        render();
    }

    function onInput(day, sessionId, key, value) {
        setSessionData(day, sessionId, key, value);
    }

    /* ====================
       RENDER
       ==================== */
    function render() {
        // Week label
        const weekLabel = document.getElementById('weekLabel');
        weekLabel.innerHTML = getWeekDisplay(currentWeek) +
            (isCurrentWeek(currentWeek) ? '<span class="text-[0.5rem] bg-gold/15 text-gold px-1.5 py-0.5 rounded-full ml-1.5 uppercase tracking-wide">Current</span>' : '');

        // Desktop tabs
        const tabsEl = document.getElementById('tabs');
        tabsEl.innerHTML = DAYS.map(day => {
            const plan = PLAN[day];
            const comp = getDayCompletion(day);
            const isActive = day === activeDay && !showHistory;
            const cls = isActive ? 'border-gold text-gold bg-gold/5' : 'border-[#222] text-gray-600 hover:border-gray-500 hover:text-gray-400';
            const dot = comp === 'done' ? 'bg-emerald-400' : comp === 'partial' ? 'bg-gold' : 'bg-[#333]';
            return '<div class="bg-surface border rounded-lg px-3 py-2 text-[0.65rem] font-semibold uppercase tracking-wide cursor-pointer transition-all ' + cls + '" data-day="' + day + '" onclick="selectDay(\'' + day + '\')">' +
                plan.name +
                '<span class="completion inline-block w-1.5 h-1.5 rounded-full ml-1.5 ' + dot + '"></span>' +
            '</div>';
        }).join('') +
        '<div class="bg-surface border rounded-lg px-3 py-2 text-[0.65rem] font-semibold uppercase tracking-wide cursor-pointer transition-all ' +
            (showHistory ? 'border-gold text-gold bg-gold/5' : 'border-[#222] text-gray-600 hover:border-gray-500 hover:text-gray-400') +
        '" onclick="selectDay(\'history\')">History</div>';

        // Mobile dropdown
        const dropdown = document.getElementById('dayDropdown');
        if (dropdown) {
            dropdown.innerHTML = DAYS.map(day => {
                const plan = PLAN[day];
                const comp = getDayCompletion(day);
                const indicator = comp === 'done' ? ' \u2713' : comp === 'partial' ? ' \u25CF' : '';
                return '<option value="' + day + '"' + (day === activeDay && !showHistory ? ' selected' : '') + '>' +
                    plan.name + indicator + '</option>';
            }).join('') +
            '<option value="history"' + (showHistory ? ' selected' : '') + '>History</option>';
        }

        // Day panels
        const panelsEl = document.getElementById('dayPanels');
        panelsEl.innerHTML = DAYS.map(day => {
            const plan = PLAN[day];
            const isActive = day === activeDay && !showHistory;
            return '<div class="' + (isActive ? 'block' : 'hidden') + ' max-w-2xl mx-auto" data-day="' + day + '">' +
                '<h2 class="text-base md:text-lg font-bold uppercase tracking-wide mb-1">' + plan.name + '</h2>' +
                '<div class="flex gap-1.5 mb-3">' +
                    plan.tags.map(t => '<span class="text-[0.5rem] md:text-[0.55rem] px-2 py-0.5 rounded-full uppercase tracking-wide font-semibold ' + TAG_CLASSES[t] + '">' + t + '</span>').join('') +
                '</div>' +
                plan.sessions.map(session => renderSession(day, session)).join('') +
            '</div>';
        }).join('');

        // History
        const historyPanel = document.getElementById('historyPanel');
        historyPanel.classList.toggle('hidden', !showHistory);
        if (showHistory) renderHistory();
    }

    function renderSession(day, session) {
        const sData = getSessionData(day, session.id);
        const completed = sData.completed === true;
        const prev = getPrevSessionData(day, session.id);

        let fieldsHtml = '';

        if (session.stations) {
            fieldsHtml = '<div class="mt-3">' +
                session.stations.map(st => {
                    const val = sData[st.id] || '';
                    const spec = st.isRun ? '' : getSpec(st.id);
                    const pv = prev ? prev[st.id] : null;
                    return '<div class="flex flex-col md:flex-row md:items-center gap-1 md:gap-2 py-2.5 border-b border-[#1a1a1a] last:border-0">' +
                        '<div class="font-semibold text-sm md:text-[0.7rem] flex items-baseline gap-1.5 md:min-w-[120px] md:flex-shrink-0 ' + (st.isRun ? 'text-hyrox' : 'text-gray-500') + '">' +
                            st.name +
                            (spec ? '<span class="text-gray-600 text-[0.65rem] md:text-[0.55rem] font-semibold">' + spec + '</span>' : '') +
                        '</div>' +
                        prevBadge(pv) +
                        '<input class="bg-dim border border-[#2a2a2a] text-gray-400 p-3 md:py-1 md:px-2 rounded-lg md:rounded-md text-base md:text-[0.7rem] outline-none w-full md:w-[90px] focus:border-gold transition-colors placeholder:text-[#444]" type="text" placeholder="' + st.placeholder + '" value="' + escHtml(val) + '"' +
                            ' oninput="onInput(\'' + day + '\',\'' + session.id + '\',\'' + st.id + '\',this.value)">' +
                    '</div>';
                }).join('') +
            '</div>';
        } else if (session.fields && session.fields.length > 0) {
            fieldsHtml = '<div class="mt-3 grid grid-cols-2 gap-2">' +
                session.fields.map(f => {
                    const val = sData[f.id] || '';
                    const pv = prev ? prev[f.id] : null;
                    return '<div class="flex flex-col gap-0.5">' +
                        '<label class="text-[0.6rem] md:text-[0.55rem] uppercase tracking-wide text-gray-600 font-semibold">' + f.label + '</label>' +
                        '<input type="text" placeholder="' + f.placeholder + '" value="' + escHtml(val) + '"' +
                            ' class="bg-dim border border-[#2a2a2a] text-gray-400 p-3 md:py-1 md:px-2 rounded-lg md:rounded-md text-base md:text-xs outline-none focus:border-gold transition-colors placeholder:text-[#444]"' +
                            ' oninput="onInput(\'' + day + '\',\'' + session.id + '\',\'' + f.id + '\',this.value)">' +
                        prevBadge(pv) +
                    '</div>';
                }).join('') +
            '</div>';
        }

        const notes = sData.notes || '';
        const notesHtml = '<div class="mt-3"><div class="flex flex-col gap-0.5">' +
            '<label class="text-[0.6rem] md:text-[0.55rem] uppercase tracking-wide text-gray-600 font-semibold">Notes</label>' +
            '<textarea placeholder="How did it feel?" class="w-full bg-dim border border-[#2a2a2a] text-gray-400 p-3 md:py-1 md:px-2 rounded-lg md:rounded-md text-base md:text-xs outline-none focus:border-gold transition-colors placeholder:text-[#444] resize-y min-h-[50px] md:min-h-[36px]"' +
                ' oninput="onInput(\'' + day + '\',\'' + session.id + '\',\'notes\',this.value)">' + escHtml(notes) + '</textarea>' +
        '</div></div>';

        return '<div class="bg-surface border rounded-xl p-3.5 md:p-4 mb-2.5 ' + (completed ? 'border-emerald-400/30' : 'border-[#222]') + '">' +
            '<div class="flex items-center gap-2.5 mb-2">' +
                '<div class="w-8 h-8 md:w-5 md:h-5 rounded-full border-2 cursor-pointer flex items-center justify-center flex-shrink-0 transition-all text-xs font-bold ' +
                    (completed ? 'bg-emerald-400 border-emerald-400 text-dark' : 'border-[#333]') +
                '" onclick="toggleComplete(\'' + day + '\',\'' + session.id + '\')">' + (completed ? '\u2713' : '') + '</div>' +
                '<div class="flex-1 min-w-0">' +
                    (session.time ? '<div class="text-[0.6rem] uppercase tracking-wide text-gray-600">' + session.time + '</div>' : '') +
                    '<div class="text-[0.95rem] md:text-sm font-semibold text-gray-400">' + session.name + '</div>' +
                    '<div class="text-xs md:text-[0.65rem] text-gray-600 mt-0.5">' + session.desc + '</div>' +
                '</div>' +
            '</div>' +
            fieldsHtml +
            notesHtml +
        '</div>';
    }

    function escHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function getPrevSessionData(day, sessionId) {
        const weeks = Object.keys(data).sort().reverse();
        for (const wk of weeks) {
            if (wk >= currentWeek) continue;
            if (data[wk][day] && data[wk][day][sessionId]) {
                return data[wk][day][sessionId];
            }
        }
        return null;
    }

    function prevBadge(val) {
        if (!val) return '';
        return '<span class="text-[0.5rem] text-gold/60 font-semibold whitespace-nowrap">Last: ' + escHtml(val) + '</span>';
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        const weeks = Object.keys(data).sort().reverse();

        if (weeks.length === 0) {
            list.innerHTML = '<div class="text-center text-gray-700 text-xs py-10">No data yet. Start logging!</div>';
            return;
        }

        list.innerHTML = weeks.map(weekId => {
            const weekData = data[weekId];
            const dots = DAYS.map(day => {
                if (!weekData[day]) return '<div class="w-2 h-2 rounded-full bg-[#222]"></div>';
                const plan = PLAN[day];
                let done = 0;
                plan.sessions.forEach(s => {
                    if (weekData[day][s.id] && weekData[day][s.id].completed) done++;
                });
                const c = done === plan.sessions.length ? 'bg-emerald-400' : done > 0 ? 'bg-gold' : 'bg-[#222]';
                return '<div class="w-2 h-2 rounded-full ' + c + '"></div>';
            }).join('');

            const totalSessions = DAYS.reduce((sum, d) => sum + PLAN[d].sessions.length, 0);
            let completedSessions = 0;
            DAYS.forEach(day => {
                if (weekData[day]) {
                    PLAN[day].sessions.forEach(s => {
                        if (weekData[day][s.id] && weekData[day][s.id].completed) completedSessions++;
                    });
                }
            });

            return '<div class="bg-surface border border-[#222] rounded-xl p-3.5 mb-2 cursor-pointer transition-colors hover:border-[#333]" onclick="jumpToWeek(\'' + weekId + '\')">' +
                '<div class="flex flex-col md:flex-row justify-between md:items-center gap-1">' +
                    '<div class="text-xs font-semibold">' + getWeekDisplay(weekId) + (isCurrentWeek(weekId) ? ' <span class="text-gold text-[0.5rem]">CURRENT</span>' : '') + '</div>' +
                    '<div class="text-[0.6rem] text-emerald-400">' + completedSessions + '/' + totalSessions + ' sessions</div>' +
                '</div>' +
                '<div class="flex gap-1 mt-2">' + dots + '</div>' +
            '</div>';
        }).join('');
    }

    function selectDay(day) {
        if (day === 'history') {
            showHistory = true;
        } else {
            activeDay = day;
            showHistory = false;
        }
        render();
    }

    function toggleMobileSettings() {
        const drawer = document.getElementById('settingsDrawer');
        const btn = document.querySelector('.mobile-settings-btn');
        drawer.classList.toggle('hidden');
        btn.classList.toggle('border-gold');
        btn.classList.toggle('text-gold');
        btn.classList.toggle('border-[#333]');
        btn.classList.toggle('text-gray-500');
    }

    function jumpToWeek(weekId) {
        currentWeek = weekId;
        showHistory = false;
        render();
    }

    /* ====================
       EXPORT / IMPORT
       ==================== */
    function exportData() {
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'hyrox-data-' + currentWeek + '.json';
        a.click();
        URL.revokeObjectURL(url);
        const btn = document.getElementById('exportBtn');
        btn.classList.add('border-emerald-400', 'text-emerald-400');
        btn.classList.remove('border-[#2a2a2a]', 'text-gray-500');
        btn.textContent = 'Exported!';
        setTimeout(() => {
            btn.classList.remove('border-emerald-400', 'text-emerald-400');
            btn.classList.add('border-[#2a2a2a]', 'text-gray-500');
            btn.textContent = 'Export';
        }, 2000);
    }

    async function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                Object.keys(imported).forEach(weekId => {
                    if (!data[weekId]) {
                        data[weekId] = imported[weekId];
                    } else {
                        Object.keys(imported[weekId]).forEach(day => {
                            if (!data[weekId][day]) {
                                data[weekId][day] = imported[weekId][day];
                            } else {
                                Object.keys(imported[weekId][day]).forEach(session => {
                                    data[weekId][day][session] = imported[weekId][day][session];
                                });
                            }
                        });
                    }
                });

                localStorage.setItem('hyrox-data', JSON.stringify(data));

                if (isCloud) {
                    for (const weekId of Object.keys(imported)) {
                        await syncWeekToCloud(weekId);
                    }
                }

                render();
                alert('Data imported successfully!');
            } catch (err) {
                alert('Invalid file. Please select a valid HYROX data export.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    }

    /* ====================
       INIT
       ==================== */
    function startTracker() {
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('signOutBtn').style.display = isCloud ? '' : 'none';
        setSyncStatus(isCloud ? 'synced' : 'local', isCloud ? 'Synced' : 'Local mode');
        setDivision(currentDivision);
        render();
    }

    async function initApp() {
        try {
            sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } catch (err) {
            console.error('Supabase init error:', err);
            return;
        }

        showOverlay('loading');
        const { data: sessionData } = await sb.auth.getSession();

        if (sessionData.session) {
            currentUser = sessionData.session.user;
            isCloud = true;
            await loadCloudData();
            showOverlay(null);
            startTracker();
        } else {
            showOverlay('auth');
        }

        sb.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                currentUser = null;
                isCloud = false;
            }
        });
    }

    initApp();
    </script>
</body>
</html>
